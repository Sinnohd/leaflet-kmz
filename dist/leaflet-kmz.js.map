{"version":3,"file":"leaflet-kmz.js","sources":["../src/utils.js","../src/KMZLayer.js","../src/KMZMarker.js","../src/KMZImageOverlay.js"],"sourcesContent":["// import JSZip from 'jszip';\n// import * as toGeoJSON from '@tmcw/togeojson';\n\nexport function loadFile(url, options) {\n\treturn new Promise((resolve, reject) => {\n\t\tlet xhr = new XMLHttpRequest();\n\t\txhr.open('GET', url);\n\t\txhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');\n\t\tif (options.hasOwnProperty('headers')) {\n\t\t\tfor (var header in options.headers) {\n\t\t\t\txhr.setRequestHeader(header, options.headers[header]);\n\t\t\t}\n\t\t}\n\t\txhr.responseType = \"arraybuffer\";\n\t\txhr.onload = () => {\n\t\t\tif (xhr.readyState === 4 && (xhr.status === 200 || xhr.status === 0)) {\n\t\t\t\tresolve(xhr.response || xhr.responseText);\n\t\t\t} else {\n\t\t\t\tresolve('');\n\t\t\t}\n\t\t};\n\t\txhr.onerror = () => reject(\"Error \" + xhr.status + \" while fetching remote file: \" + url);\n\t\txhr.send();\n\t});\n}\n\nexport function getKmlDoc(files) {\n\treturn files[\"doc.kml\"] ? \"doc.kml\" : getKmlFiles(Object.keys(files))[0];\n}\n\nexport function getKmlFiles(files) {\n\treturn files.filter((file) => isKmlFile(file));\n}\n\nexport function getImageFiles(files) {\n\treturn files.filter((file) => isImageFile(file));\n}\n\nexport function getFileExt(filename) {\n\treturn filename.split('.').pop().toLowerCase().replace('jpg', 'jpeg');\n}\n\nexport function getFileName(url) {\n\treturn url.split('/').pop();\n}\n\nexport function getMimeType(filename, ext) {\n\tvar mime = 'text/plain';\n\tif (/\\.(jpe?g|png|gif|bmp)$/i.test(filename)) {\n\t\tmime = 'image/' + ext;\n\t} else if (/\\.kml$/i.test(filename)) {\n\t\tmime = 'text/plain';\n\t}\n\treturn mime;\n}\n\nexport function isImageFile(filename) {\n\treturn /\\.(jpe?g|png|gif|bmp)$/i.test(filename);\n}\n\nexport function isKmlFile(filename) {\n\treturn /.*\\.kml/.test(filename);\n}\n\n/**\n * It checks if a given file begins with PK, if so it's zipped\n *\n * @link https://en.wikipedia.org/wiki/List_of_file_signatures\n */\nexport function isZipped(file) {\n\treturn 'PK' === String.fromCharCode(new Uint8Array(file, 0, 1), new Uint8Array(file, 1, 1));\n}\n\nexport function lazyLoader(urls, promise) {\n\treturn promise instanceof Promise ? promise : Promise.all(urls.map(url => loadJS(url)))\n}\n\nexport function loadJS(url) {\n\treturn new Promise((resolve, reject) => {\n\t\tlet tag = document.createElement(\"script\");\n\t\ttag.addEventListener('load', resolve.bind(url), { once: true });\n\t\ttag.src = url;\n\t\tdocument.head.appendChild(tag);\n\t});\n}\n\nexport function parseLatLonBox(xml) {\n\tlet box = L.latLngBounds([\n\t\txml.getElementsByTagName('south')[0].childNodes[0].nodeValue,\n\t\txml.getElementsByTagName('west')[0].childNodes[0].nodeValue\n\t], [\n\t\txml.getElementsByTagName('north')[0].childNodes[0].nodeValue,\n\t\txml.getElementsByTagName('east')[0].childNodes[0].nodeValue\n\t]);\n\tlet rotation = xml.getElementsByTagName('rotation')[0];\n\tif (rotation !== undefined) {\n\t\trotation = parseFloat(rotation.childNodes[0].nodeValue);\n\t}\n\treturn [box, rotation];\n}\n\nexport function parseGroundOverlay(xml, props) {\n\tlet [bounds, rotation] = parseLatLonBox(xml.getElementsByTagName('LatLonBox')[0]);\n\tlet href = xml.getElementsByTagName('href')[0];\n\tlet color = xml.getElementsByTagName('color')[0];\n\tlet icon = xml.getElementsByTagName('Icon')[0];\n\tlet options = {};\n\tif (!href && icon) {\n\t\thref = icon.getElementsByTagName('href')[0];\n\t}\n\thref = href.childNodes[0].nodeValue;\n\thref = props.icons[href] || href;\n\tif (color) {\n\t\tcolor = color.childNodes[0].nodeValue;\n\t\toptions.opacity = parseInt(color.substring(0, 2), 16) / 255.0;\n\t\toptions.color = '#' + color.substring(6, 8) + color.substring(4, 6) + color.substring(2, 4);\n\t}\n\tif (rotation) {\n\t\toptions.rotation = rotation;\n\t}\n\treturn new L.KMZImageOverlay(href, bounds, { opacity: options.opacity, angle: options.rotation });\n}\n\nexport function toGeoJSON(data, props) {\n\tvar xml = data instanceof XMLDocument ? data : toXML(data);\n\tvar json = window.toGeoJSON.kml(xml);\n\tjson.properties = L.extend({}, json.properties, props || {});\n\treturn json;\n}\n\nexport function toXML(data) {\n\tvar text = data;\n\tif (data instanceof ArrayBuffer) {\n\t\ttext = new Uint8Array(data).reduce(function (data, byte) {\n\t\t\treturn data + String.fromCharCode(byte);\n\t\t}, '');\n\t\tvar encoding = text.substring(0, text.indexOf(\"?>\")).match(/encoding\\s*=\\s*[\"'](.*)[\"']/i);\n\t\tif (encoding) {\n\t\t\ttext = new TextDecoder(encoding[1]).decode(data);\n\t\t}\n\t}\n\treturn text ? (new DOMParser()).parseFromString(text, 'text/xml') : document.implementation.createDocument(null, \"kml\");;\n}\n\nexport function unzip(folder) {\n\treturn new Promise((resolve, reject) => {\n\t\twindow.JSZip.loadAsync(folder)\n\t\t\t.then((zip) => {\n\n\t\t\t\t// Parse KMZ files.\n\t\t\t\tvar files = Object.keys(zip.files)\n\t\t\t\t\t.map((name) => {\n\t\t\t\t\t\tvar entry = zip.files[name];\n\t\t\t\t\t\tif (isImageFile(name)) {\n\t\t\t\t\t\t\tvar ext = getFileExt(name);\n\t\t\t\t\t\t\tvar mime = getMimeType(name, ext);\n\t\t\t\t\t\t\treturn entry\n\t\t\t\t\t\t\t\t.async(\"base64\")\n\t\t\t\t\t\t\t\t.then((value) => [name, 'data:' + mime + ';base64,' + value]);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn entry\n\t\t\t\t\t\t\t.async(\"text\")\n\t\t\t\t\t\t\t.then((value) => [name, value]); // [ fileName, stringValue ]\n\t\t\t\t\t});\n\n\t\t\t\t// Return KMZ files.\n\t\t\t\tPromise.all(files).then((list) =>\n\t\t\t\t\tresolve(list.reduce((obj, item) => {\n\t\t\t\t\t\tobj[item[0]] = item[1]; // { fileName: stringValue }\n\t\t\t\t\t\treturn obj;\n\t\t\t\t\t}, {}))\n\t\t\t\t);\n\t\t\t});\n\t});\n}\n","import * as _ from './utils';\n\nexport const KMZLayer = L.KMZLayer = L.FeatureGroup.extend({\n\toptions: {\n\t\tinteractive: true,\n\t\tballon: true,\n\t\tbindPopup: true,\n\t\tbindTooltip: true,\n\t\tpreferCanvas: false,\n\t},\n\n\tinitialize: function(kmzUrl, options) {\n\t\tL.extend(this.options, options);\n\n\t\tif (L.Browser.mobile) this.options.bindTooltip = false;\n\n\t\tthis._layers = {};\n\n\t\tif (kmzUrl) this.load(kmzUrl);\n\t},\n\n\tadd: function(kmzUrl, options) {\n\t\tthis.load(kmzUrl, options);\n\t},\n\n\tload: function(kmzUrl, options) {\n\t\tL.KMZLayer._jsPromise = _.lazyLoader(this._requiredJSModules(), L.KMZLayer._jsPromise)\n\t\t\t.then(() => _.loadFile(kmzUrl, options))\n\t\t\t.then((data) => this.parse(data, { name: _.getFileName(kmzUrl), icons: {} }));\n\t},\n\n\tparse: function(data, props) {\n\t\treturn _.isZipped(data) ? this._parseKMZ(data, props) : this._parseKML(data, props);\n\t},\n\n\t_parseKMZ: function(data, props) {\n\t\t_.unzip(data).then((kmzFiles) => {\n\t\t\tvar kmlDoc = _.getKmlDoc(kmzFiles);\n\t\t\tvar images = _.getImageFiles(Object.keys(kmzFiles));\n\n\t\t\tvar kmlString = kmzFiles[kmlDoc];\n\t\t\t// cache all images with their base64 encoding\n\t\t\tprops.icons = images.reduce((obj, item) => {\n\t\t\t\tobj[item] = kmzFiles[item];\n\t\t\t\treturn obj;\n\t\t\t}, {});\n\n\t\t\tthis._parseKML(kmlString, props);\n\t\t});\n\t},\n\n\t_parseKML: function(data, props) {\n\t\tvar xml = _.toXML(data, props);\n\t\tvar geojson = _.toGeoJSON(xml, props);\n\t\tvar layer = (this.options.geometryToLayer || this._geometryToLayer).call(this, geojson, xml);\n\t\tthis.addLayer(layer);\n\t\tthis.fire('load', { layer: layer, name: geojson.properties.name });\n\t},\n\n\t_geometryToLayer: function(data, xml) {\n\t\tvar preferCanvas = this._map ? this._map.options.preferCanvas : this.options.preferCanvas;\n\t\tvar emptyIcon    = \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E\";\n\t\t// parse GeoJSON\n\t\tvar layer = L.geoJson(data, {\n\t\t\tpointToLayer: (feature, latlng) => {\n\t\t\t\tif (preferCanvas) {\n\t\t\t\t\treturn L.kmzMarker(latlng, {\n\t\t\t\t\t\ticonUrl: data.properties.icons[feature.properties.icon] || feature.properties.icon || emptyIcon,\n\t\t\t\t\t\ticonSize: [28, 28],\n\t\t\t\t\t\ticonAnchor: [14, 14],\n\t\t\t\t\t\tinteractive: this.options.interactive,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t// TODO: handle L.svg renderer within the L.KMZMarker class?\n\t\t\t\treturn L.marker(latlng, {\n\t\t\t\t\ticon: L.icon({\n\t\t\t\t\t\ticonUrl: data.properties.icons[feature.properties.icon] || feature.properties.icon || emptyIcon,\n\t\t\t\t\t\ticonSize: [28, 28],\n\t\t\t\t\t\ticonAnchor: [14, 14],\n\t\t\t\t\t}),\n\t\t\t\t\tinteractive: this.options.interactive,\n\t\t\t\t});\n\t\t\t},\n\t\t\tstyle: (feature) => {\n\t\t\t\tvar styles = {};\n\t\t\t\tvar prop = feature.properties;\n\n\t\t\t\tif (prop.stroke) {\n\t\t\t\t\tstyles.stroke = true;\n\t\t\t\t\tstyles.color = prop.stroke;\n\t\t\t\t}\n\t\t\t\tif (prop.fill) {\n\t\t\t\t\tstyles.fill = true;\n\t\t\t\t\tstyles.fillColor = prop.fill;\n\t\t\t\t}\n\t\t\t\tif (prop[\"stroke-opacity\"]) {\n\t\t\t\t\tstyles.opacity = prop[\"stroke-opacity\"];\n\t\t\t\t}\n\t\t\t\tif (prop[\"fill-opacity\"]) {\n\t\t\t\t\tstyles.fillOpacity = prop[\"fill-opacity\"];\n\t\t\t\t}\n\t\t\t\tif (prop[\"stroke-width\"]) {\n\t\t\t\t\tstyles.weight = prop[\"stroke-width\"] * 1.05;\n\t\t\t\t}\n\n\t\t\t\treturn styles;\n\t\t\t},\n\t\t\tonEachFeature: (feature, layer) => {\n\t\t\t\tif (!this.options.ballon) return;\n\n\t\t\t\tvar prop = feature.properties;\n\t\t\t\tvar name = prop.name || \"\";\n\t\t\t\tvar desc = prop.description || \"\";\n\n\t\t\t\tif (name || desc) {\n\t\t\t\t\tif (this.options.bindPopup) {\n\t\t\t\t\t\tlayer.bindPopup('<div>' + '<b>' + name + '</b>' + '<br>' + desc + '</div>');\n\t\t\t\t\t}\n\t\t\t\t\tif (this.options.bindTooltip) {\n\t\t\t\t\t\tlayer.bindTooltip('<b>' + name + '</b>', {\n\t\t\t\t\t\t\tdirection: 'auto',\n\t\t\t\t\t\t\tsticky: true,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\tinteractive: this.options.interactive,\n\t\t});\n\t\t// parse GroundOverlays\n\t\tlet el = xml.getElementsByTagName('GroundOverlay');\n\t\tfor (let l, k = 0; k < el.length; k++) {\n\t\t\tl = _.parseGroundOverlay(el[k], data.properties);\n\t\t\tif (l) {\n\t\t\t\tlayer.addLayer(l);\n\t\t\t}\n\t\t}\n\t\treturn layer;\n\t},\n\n\t_requiredJSModules: function() {\n\t\tvar urls = [];\n\t\tvar host = 'https://unpkg.com/';\n\n\t\tif (typeof window.JSZip !== 'function') {\n\t\t\turls.push(host + 'jszip@3.5.0/dist/jszip.min.js');\n\t\t}\n\t\tif (typeof window.toGeoJSON !== 'object') {\n\t\t\turls.push(host + '@tmcw/togeojson@4.1.0/dist/togeojson.umd.js');\n\t\t}\n\n\t\treturn urls;\n\t},\n});\n\nL.kmzLayer = function(url, options) {\n\treturn new L.KMZLayer(url, options);\n};\n","/**\n * Optimized leaflet canvas renderer to load numerous markers\n *\n * @link https://stackoverflow.com/a/51852641\n * @link https://stackoverflow.com/a/43019740\n *\n */\nL.KMZMarker = L.CircleMarker.extend({\n\t// initialize: function(latlng, options) {\n\t// \tL.CircleMarker.prototype.initialize.call(this, latlng, options);\n\t// },\n\t_updatePath: function() {\n\t\tvar renderer = this._renderer;\n\t\tvar icon = this._icon;\n\t\tvar layer = this;\n\n\t\tif (!renderer._drawing || layer._empty()) {\n\t\t\treturn;\n\t\t}\n\n\t\t// if (icon.complete)\n\t\tif (icon) {\n\t\t\ticon.drawImage();\n\t\t} else {\n\t\t\ticon = this._icon = new Image(this.options.iconSize[0], this.options.iconSize[1]);\n\t\t\ticon.anchor = [icon.width / 2.0, icon.height / 2.0];\n\t\t\ticon.onload = icon.drawImage = () => {\n\t\t\t\tvar p = layer._point.subtract(icon.anchor);\n\t\t\t\tvar ctx = renderer._ctx;\n\n\t\t\t\tctx.drawImage(icon, p.x, p.y, icon.width, icon.height);\n\n\t\t\t\t// Removed in Leaflet 1.4.0\n\t\t\t\t// if (renderer._drawnLayers) renderer._drawnLayers[layer._leaflet_id] = layer;\n\t\t\t\t// else renderer._layers[layer._leaflet_id] = layer;\n\t\t\t};\n\t\t\ticon.src = this.options.iconUrl;\n\t\t}\n\t}\n});\n\nL.kmzMarker = function(ll, opts) {\n\treturn new L.KMZMarker(ll, opts);\n};\n\nexport var KMZMarker = L.KMZMarker;\n","/**\n * Copyright (c) 2011-2015, Pavel Shramov, Bruno Bergot - MIT licence\n *\n * adapted from: https://github.com/windycom/leaflet-kml/L.KML.js\n */\nL.KMZImageOverlay = L.ImageOverlay.extend({\n\toptions: {\n\t\tangle: 0\n\t},\n\t_reset: function() {\n\t\tL.ImageOverlay.prototype._reset.call(this);\n\t\tthis._rotate();\n\t},\n\t_animateZoom: function(e) {\n\t\tL.ImageOverlay.prototype._animateZoom.call(this, e);\n\t\tthis._rotate();\n\t},\n\t_rotate: function() {\n\t\tif (L.DomUtil.TRANSFORM) {\n\t\t\t// use the CSS transform rule if available\n\t\t\tthis._image.style[L.DomUtil.TRANSFORM] += ' rotate(' + this.options.angle + 'deg)';\n\t\t} else if (L.Browser.ie) {\n\t\t\t// fallback for IE6, IE7, IE8\n\t\t\tvar rad = this.options.angle * (Math.PI / 180),\n\t\t\t\tcostheta = Math.cos(rad),\n\t\t\t\tsintheta = Math.sin(rad);\n\t\t\tthis._image.style.filter += ' progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\\'auto expand\\', M11=' +\n\t\t\t\tcostheta + ', M12=' + (-sintheta) + ', M21=' + sintheta + ', M22=' + costheta + ')';\n\t\t}\n\t},\n\tgetBounds: function() {\n\t\treturn this._bounds;\n\t}\n});\n"],"names":["getKmlDoc","files","filter","file","test","getKmlFiles","Object","keys","isImageFile","filename","lazyLoader","urls","promise","Promise","all","map","url","resolve","reject","tag","document","createElement","addEventListener","bind","once","src","head","appendChild","loadJS","parseGroundOverlay","xml","props","bounds","rotation","box","L","latLngBounds","getElementsByTagName","childNodes","nodeValue","undefined","parseFloat","parseLatLonBox","href","color","icon","options","icons","opacity","parseInt","substring","KMZImageOverlay","angle","toXML","data","text","ArrayBuffer","encoding","Uint8Array","reduce","byte","String","fromCharCode","indexOf","match","TextDecoder","decode","DOMParser","parseFromString","implementation","createDocument","KMZLayer","FeatureGroup","extend","interactive","ballon","bindPopup","bindTooltip","preferCanvas","initialize","kmzUrl","this","Browser","mobile","_layers","load","add","_jsPromise","_.lazyLoader","_requiredJSModules","then","xhr","XMLHttpRequest","open","setRequestHeader","hasOwnProperty","header","headers","responseType","onload","readyState","status","response","responseText","onerror","send","_.loadFile","parse","name","split","pop","_parseKMZ","_parseKML","folder","window","JSZip","loadAsync","zip","entry","ext","toLowerCase","replace","mime","getMimeType","async","value","list","obj","item","kmzFiles","kmlDoc","_.getKmlDoc","images","kmlString","_.toXML","geojson","XMLDocument","json","toGeoJSON","kml","properties","_.toGeoJSON","layer","geometryToLayer","_geometryToLayer","call","addLayer","fire","_map","emptyIcon","geoJson","pointToLayer","feature","latlng","kmzMarker","iconUrl","iconSize","iconAnchor","marker","style","styles","prop","stroke","fill","fillColor","fillOpacity","weight","onEachFeature","desc","description","direction","sticky","el","l","k","length","_.parseGroundOverlay","host","push","kmzLayer","KMZMarker","CircleMarker","_updatePath","renderer","_renderer","_icon","_drawing","_empty","drawImage","Image","anchor","width","height","p","_point","subtract","_ctx","x","y","ll","opts","ImageOverlay","_reset","prototype","_rotate","_animateZoom","e","DomUtil","TRANSFORM","_image","ie","rad","Math","PI","costheta","cos","sintheta","sin","getBounds","_bounds"],"mappings":"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"}